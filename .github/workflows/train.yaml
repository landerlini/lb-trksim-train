name: Train models

on:
  pull_request:
    branches:
      - main

jobs:
    #run-workflow:
    #    uses: ./.github/workflows/shared.yaml
    #    with:
    #        name: deploy
    #        target: deploy
    #        additional_profile: |
    #            rerun-triggers: mtime
    #    secrets:
    #        SECRETS_YAML: ${{ secrets.STORAGE_SECRETS }}

    upload_dot_c:
      runs-on: ubuntu-latest
      container: harbor.cloud.infn.it/unpacked/aiinfn-gha-runner:latest
    #  needs: run-workflow
      steps:
        - name: Install missing libraries
          run: |
            sudo apt-get update 
            sudo apt-get install -y xz-utils
 
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Retrieve secrets
          run: |
              mkdir -p /tmp/artifacts
              cat <<EOF > /tmp/artifacts/secrets.yaml
              ${{ secrets.STORAGE_SECRETS }}
              EOF

        - name: compress_file
          run: |
              cd notebooks
              export SNAKEMAKE_PROFILE=$PWD//workflow/profile/
              snakemake compress_dotC \
                --allowed-rules compress_dotC \
                --jobs 1 \
                --config secrets_file=/tmp/artifacts/secrets.yaml \
                --rerun-incomplete \
                --local-storage-prefix /tmp 
                
        - name: Upload compressed model
          uses: actions/upload-artifact@v4
          with:
            name: compiled_model.C.xz
            path: /tmp/compiled_model.C.xz

    compile:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          vm: [ubuntu-latest, ubuntu-24.04-arm]
          container: ["centos:7", "alma:9"]
          optimization: [-O0, -O2]

      steps:
        - name: Install missing libraries
          run: |
            sudo apt-get update 
            sudo apt-get install -y xz-utils gcc
 
        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: my-artifact
            path: ./downloaded

